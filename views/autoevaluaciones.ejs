<!-- AUTOEVALUACIONES · iOS minimal -->
<style>
  :root{
    --ink:#0f172a;
    --muted:#64748b;
    --card:#ffffff;
    --stroke:#e7edf5;
    --shadow: 0 18px 30px rgba(15,23,42,.10);
    --shadowSoft: 0 10px 22px rgba(15,23,42,.08);
    --radius:18px;
  }
  .search-wrap{ position:relative; }
  .search-icon{ position:absolute; left:12px; top:50%; transform:translateY(-50%); opacity:.75; }
  .search-ios{
    width: 240px;
    border:1px solid var(--stroke);
    border-radius:9999px;
    padding:10px 12px 10px 38px;
    outline:none;
    background:#fff;
    box-shadow: var(--shadowSoft);
    font-weight:600;
    color:var(--ink);
  }
  .search-ios::placeholder{ color:#94a3b8; font-weight:600; }
  .card{
    background: var(--card);
    border: 1px solid var(--stroke);
    border-radius: var(--radius);
    box-shadow: var(--shadowSoft);
  }
  .tile{ transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease; }
  .tile:hover{ transform: translateY(-1px); box-shadow: var(--shadow); border-color:#d7e3f3; }
  .year-panel{
    position: fixed;
    left: 16px;
    top: 110px;
    width: 112px;
    display:flex;
    flex-direction:column;
    gap: 10px;
    z-index: 20;
  }
  .year-btn{
    width: 112px;
    border-radius: 9999px;
    padding: 10px 10px;
    font-weight: 800;
    border:1px solid var(--stroke);
    background: rgba(255,255,255,.9);
    box-shadow: var(--shadowSoft);
    color: var(--ink);
    cursor: pointer;
  }
  .year-btn.active{
    background:#0ea5e9;
    color:white;
    border-color:#0ea5e9;
  }
  @media (max-width: 1024px){
    .year-panel{
      position: static;
      width: 100%;
      flex-direction: row;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 10px;
      left: auto; top: auto;
    }
    .year-btn{ width:auto; padding: 10px 14px; }
  }
</style>

<div class="max-w-6xl mx-auto px-4 md:px-6 pt-2 md:pt-3 pb-4 md:pb-6">
  <!-- FILA: título y búsqueda -->
  <div class="flex items-center justify-between mb-2">
    <div>
      <h1 class="text-xl md:text-2xl font-semibold">Autoevaluaciones</h1>
      <div class="text-sm text-slate-500">Elegí año y materia para practicar</div>
    </div>

    <div class="search-wrap">
      <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#9aa4b2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <circle cx="11" cy="11" r="7"></circle>
        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
      </svg>
      <input id="qSubjects" class="search-ios" placeholder="Buscar materia" />
    </div>
  </div>

  <!-- Panel izquierdo (años) -->
  <aside class="year-panel" id="yearPanel" aria-label="Filtrar por año">
    <button class="year-btn" data-year="1">1º</button>
    <button class="year-btn" data-year="2">2º</button>
    <button class="year-btn" data-year="3">3º</button>
    <button class="year-btn" data-year="4">4º</button>
    <button class="year-btn" data-year="5">5º</button>
    <button class="year-btn" data-year="all">Todos</button>
  </aside>

  <!-- Lista de materias -->
  <div id="subjectsGrid" class="grid sm:grid-cols-2 md:grid-cols-3 gap-4 pl-[132px] lg:pl-0">
    <%
        // Filtramos solo las materias de la carrera/plan del usuario (robusto)
        // - normalizamos career (minúsculas, sin tildes, sin puntos, espacios)
        // - plan siempre como entero (7, 8, etc) aunque venga "7.0" o "7,0"
        function normCareer(v){
          return String(v || '')
            .toLowerCase()
            .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
            .replace(/\./g,'')
            .replace(/\s+/g,' ')
            .trim();
        }
        function planInt(v){
          const raw = String(v ?? '').trim().replace(',', '.');
          const n = parseInt(raw.split('.')[0], 10);
          return Number.isFinite(n) ? n : 0;
        }

        const uCareer = normCareer((typeof carrera !== 'undefined' && carrera) ? carrera : (user?.career || ''));
        const uPlan   = planInt((typeof plan   !== 'undefined' && plan)   ? plan   : (user?.plan   ?? ''));

        const _subs = (subjects || []).filter(s => {
          // Si no hay perfil, mostramos todo (fallback)
          if (!uCareer || !uPlan) return true;
          const sCareer = normCareer(s.career);
          const sPlan   = planInt(s.plan);
          return sCareer === uCareer && sPlan === uPlan;
        });
      %>

    <% if (_subs.length) { %>
      <% _subs.forEach(function(s){ %>
        <button
          class="card tile w-full p-4 text-left focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
          data-subject-id="<%= s.id %>"
          data-subject-name="<%- s.name %>"
          data-name="<%- (s.name||'').toLowerCase() %>"
          data-year="<%= s.year %>">
          <div class="flex items-center justify-between">
            <div class="min-w-0 font-semibold truncate text-slate-900"><%= s.name %></div>
            <div class="text-xs text-slate-600"><%= s.year %>º</div>
          </div>
          <div class="mt-1 text-xs text-slate-500/80 truncate">
            <%= s.career %> · Plan <%= s.plan %>
          </div>
          <div class="mt-3 text-xs text-slate-400">Click para comenzar</div>
        </button>
      <% }) %>
    <% } else { %>
      <div class="col-span-full text-center text-slate-500 py-12">
        No hay materias para tu perfil (<%= (typeof carrera !== 'undefined' ? carrera : user?.career) %> · Plan <%= (typeof plan !== 'undefined' ? plan : user?.plan) %>).
      </div>
    <% } %>
  </div>
</div>

<script>
  // UI: búsqueda + filtro por año (front)
  const q = document.getElementById('qSubjects');
  const grid = document.getElementById('subjectsGrid');
  const yearPanel = document.getElementById('yearPanel');
  let activeYear = 'all';

  function applyFilters(){
    const term = (q.value || '').trim().toLowerCase();
    const items = grid.querySelectorAll('button[data-subject-id]');
    items.forEach(btn => {
      const name = (btn.dataset.name || '');
      const y = String(btn.dataset.year || '');
      const okText = !term || name.includes(term);
      const okYear = (activeYear === 'all') || (y === String(activeYear));
      btn.style.display = (okText && okYear) ? '' : 'none';
    });
  }

  q?.addEventListener('input', applyFilters);

  yearPanel?.addEventListener('click', (e) => {
    const b = e.target.closest('.year-btn');
    if (!b) return;
    activeYear = b.dataset.year || 'all';
    yearPanel.querySelectorAll('.year-btn').forEach(x => x.classList.remove('active'));
    b.classList.add('active');
    applyFilters();
  });

  // default
  yearPanel?.querySelector('[data-year="all"]')?.classList.add('active');
</script>
