<%
const ALLOWED_CAREERS = [
  'Lic. en Administración de Empresas',
  'Contabilidad',
  'Lic. en Economía'
];

const PLANS_BY_CAREER = {
  'Lic. en Administración de Empresas': ['6','7','8'],
  'Contabilidad': ['6','7'],
  'Lic. en Economía': ['6','7'],
};

const _form = (typeof form !== 'undefined' && form) ? form : {};

const _careers = ALLOWED_CAREERS;

// carrera inicial válida
const initialCareer = _careers.includes(String(_form.career || '')) ? String(_form.career) : '';

// plan inicial: si es 0 o inválido => vacío
const rawPlan = String((_form.plan ?? '')).trim();
const initialPlan =
  rawPlan === '0' ? '' :
  (initialCareer && (PLANS_BY_CAREER[initialCareer] || []).includes(rawPlan) ? rawPlan : '');
%>

<div class="auth-split relative">
  <div class="auth-line" aria-hidden="true"></div>

  <div class="auth-center grid grid-cols-1 lg:grid-cols-2 items-center relative z-10">
    <section class="hidden lg:block"></section>

    <section class="px-6 sm:px-10 lg:pl-20">
      <h1 class="text-4xl sm:text-5xl font-semibold tracking-tight mb-3">Crear cuenta</h1>
      <p class="text-sm sm:text-base text-slate-500 mb-6">Elegí tu carrera y plan para ver el material correcto.</p>

      <% if (typeof error !== "undefined" && error) { %>
        <div class="mb-4 text-sm text-red-600"><%= error %></div>
      <% } %>

      <form id="registerForm" method="POST" action="/register" class="space-y-3 max-w-md" novalidate>
        <label class="block">
          <span class="ios-label">Nombre y apellido</span>
          <input class="ios-input" type="text" name="name" required placeholder="Tu nombre"
            value="<%= _form.name || '' %>" autocomplete="name"/>
        </label>

        <label class="block">
          <span class="ios-label">Email</span>
          <input class="ios-input" type="email" name="email" required placeholder="tu@email.com"
            value="<%= (typeof _form.email !== 'undefined') ? _form.email : '' %>" autocomplete="email"/>
        </label>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <label class="block">
            <span class="ios-label">Contraseña</span>
            <div class="ios-input-wrap">
              <input class="ios-input" id="regPw" type="password" name="password" required placeholder="••••••••" autocomplete="new-password"/>
              <button type="button" class="ios-pw-toggle" data-pw-target="regPw" style="color: orange;">Mostrar</button>
            </div>
          </label>

          <label class="block">
            <span class="ios-label">Repetir contraseña</span>
            <div class="ios-input-wrap">
              <input class="ios-input" id="regPw2" type="password" name="password_repeat" required placeholder="••••••••" autocomplete="new-password"/>
              <button type="button" class="ios-pw-toggle" data-pw-target="regPw2" style="color: orange;">Mostrar</button>
            </div>
          </label>
        </div>
        <p id="pwError" class="text-xs sm:text-sm text-red-600 hidden">Las contraseñas no coinciden.</p>

        <label class="block">
          <span class="ios-label">Número de teléfono</span>
          <input class="ios-input" type="tel" name="phone" inputmode="tel" placeholder="+54 9 11 1234-5678"
            value="<%= _form.phone || '' %>" autocomplete="tel"/>
        </label>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <label class="block">
            <span class="ios-label">Carrera</span>

            <select class="ios-input native-select" name="career" required aria-hidden="true" tabindex="-1" id="careerSelectNative">
              <option value="">Elegir…</option>
              <% _careers.forEach(function(c){ %>
                <option value="<%= c %>" <%= (initialCareer === c) ? 'selected' : '' %>><%= c %></option>
              <% }) %>
            </select>

            <div class="cs-select" data-select="career" id="careerSelectCustom">
              <button type="button" class="cs-trigger" aria-haspopup="listbox" aria-expanded="false">
                <span class="cs-value"><%= initialCareer || 'Elegir…' %></span>
                <svg class="cs-chevron" viewBox="0 0 24 24" aria-hidden="true">
                  <polyline points="6,9 12,15 18,9" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></polyline>
                </svg>
              </button>
              <ul class="cs-menu" role="listbox" tabindex="-1">
                <li class="cs-option <%= !initialCareer ? 'is-selected':'' %>" data-value="">Elegir…</li>
                <% _careers.forEach(function(c){ %>
                  <li class="cs-option <%= (initialCareer===c)?'is-selected':'' %>" data-value="<%= c %>"><%= c %></li>
                <% }) %>
              </ul>
            </div>
          </label>

          <label class="block">
            <span class="ios-label">Plan</span>

            <select class="ios-input native-select" name="plan" required aria-hidden="true" tabindex="-1" id="planSelectNative">
              <option value="">Elegir…</option>
              <% (initialCareer ? (PLANS_BY_CAREER[initialCareer]||[]) : []).forEach(function(p){ %>
                <option value="<%= p %>" <%= (initialPlan===p)?'selected':'' %>><%= 'Plan ' + p %></option>
              <% }) %>
            </select>

            <div class="cs-select" data-select="plan" id="planSelectCustom">
              <button type="button" class="cs-trigger" aria-haspopup="listbox" aria-expanded="false">
                <span class="cs-value"><%= initialPlan ? ('Plan ' + initialPlan) : 'Elegir…' %></span>
                <svg class="cs-chevron" viewBox="0 0 24 24" aria-hidden="true">
                  <polyline points="6,9 12,15 18,9" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></polyline>
                </svg>
              </button>
              <ul class="cs-menu" role="listbox" tabindex="-1">
                <li class="cs-option <%= !initialPlan ? 'is-selected':'' %>" data-value="">Elegir…</li>
                <% (initialCareer ? (PLANS_BY_CAREER[initialCareer]||[]) : []).forEach(function(p){ %>
                  <li class="cs-option <%= (initialPlan===p)?'is-selected':'' %>" data-value="<%= p %>"><%= 'Plan ' + p %></li>
                <% }) %>
              </ul>
            </div>
          </label>
        </div>

        <button class="ios-btn-primary w-full mt-1 bg-[#F8C160]">Crear cuenta</button>
      </form>

      <div class="mt-6 text-sm text-slate-500">
        ¿Ya tenés cuenta?
        <a class="ios-link" href="/login" style="color: orange;">Iniciar sesión</a>
      </div>
    </section>
  </div>
</div>

<script>
  document.querySelectorAll('.ios-pw-toggle').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.getAttribute('data-pw-target');
      const input = document.getElementById(id);
      if (!input) return;
      input.type = input.type === 'password' ? 'text' : 'password';
      btn.textContent = input.type === 'password' ? 'Mostrar' : 'Ocultar';
    });
  });

  const form = document.getElementById('registerForm');
  const pw1  = document.getElementById('regPw');
  const pw2  = document.getElementById('regPw2');
  const pwErr = document.getElementById('pwError');

  function checkPwMatch() {
    const ok = pw1.value === pw2.value;
    pwErr.classList.toggle('hidden', ok);
    return ok;
  }
  pw1.addEventListener('input', checkPwMatch);
  pw2.addEventListener('input', checkPwMatch);
  form.addEventListener('submit', (e) => {
    if (!checkPwMatch()) { e.preventDefault(); pw2.focus(); }
  });

  (function(){
    const PLANS_BY_CAREER = {
      "Lic. en Administración de Empresas": ["6","7","8"],
      "Contabilidad": ["6","7"],
      "Lic. en Economía": ["6","7"]
    };

    function setupCsSelect(root){
      const trigger = root.querySelector('.cs-trigger');
      const valueEl = root.querySelector('.cs-value');
      const menu    = root.querySelector('.cs-menu');
      let options   = Array.from(root.querySelectorAll('.cs-option'));
      const native  = root.parentElement.querySelector('select.native-select');

      function close(){ root.classList.remove('is-open'); trigger.setAttribute('aria-expanded','false'); }
      function open(){ root.classList.add('is-open'); trigger.setAttribute('aria-expanded','true'); }
      function setVal(val, label){
        valueEl.textContent = label || val || 'Elegir…';
        if (native){
          native.value = val;
          native.dispatchEvent(new Event('change', { bubbles:true }));
        }
      }
      function select(li){
        options.forEach(o=>o.classList.remove('is-selected'));
        li.classList.add('is-selected');
        setVal(li.getAttribute('data-value'), (li.textContent || '').trim());
        close();
      }

      trigger.addEventListener('click', (e)=>{
        e.preventDefault();
        root.classList.contains('is-open') ? close() : open();
      });

      options.forEach(li=> li.addEventListener('click', ()=>select(li)));

      document.addEventListener('click', (e)=>{
        if (!root.contains(e.target)) close();
      });

      root._csRefresh = function(){
        options = Array.from(root.querySelectorAll('.cs-option'));
      };
    }

    document.querySelectorAll('.cs-select').forEach(setupCsSelect);

    const nativeCareer = document.getElementById('careerSelectNative');
    const nativePlan   = document.getElementById('planSelectNative');
    const customPlan   = document.getElementById('planSelectCustom');

    function rebuildPlanOptions(career){
      const plans = (PLANS_BY_CAREER[career] || []);

      // ✅ nativo: nunca “0”
      nativePlan.innerHTML = '';
      const optEmpty = document.createElement('option');
      optEmpty.value = '';
      optEmpty.textContent = 'Elegir…';
      nativePlan.appendChild(optEmpty);
      plans.forEach(p=>{
        const op = document.createElement('option');
        op.value = p;
        op.textContent = 'Plan ' + p;
        nativePlan.appendChild(op);
      });
      nativePlan.value = '';

      // ✅ custom
      const menu = customPlan.querySelector('.cs-menu');
      const valEl= customPlan.querySelector('.cs-value');
      menu.innerHTML = '';

      const liEmpty = document.createElement('li');
      liEmpty.className = 'cs-option is-selected';
      liEmpty.dataset.value = '';
      liEmpty.textContent = 'Elegir…';
      menu.appendChild(liEmpty);

      plans.forEach(p=>{
        const li = document.createElement('li');
        li.className = 'cs-option';
        li.dataset.value = p;
        li.textContent = 'Plan ' + p;
        menu.appendChild(li);
      });

      customPlan._csRefresh && customPlan._csRefresh();

      menu.querySelectorAll('.cs-option').forEach(li=>{
        li.addEventListener('click', ()=>{
          menu.querySelectorAll('.cs-option').forEach(o=>o.classList.remove('is-selected'));
          li.classList.add('is-selected');
          const v = li.dataset.value || '';
          nativePlan.value = v;
          valEl.textContent = v ? ('Plan ' + v) : 'Elegir…';
        });
      });

      valEl.textContent = 'Elegir…';
    }

    nativeCareer.addEventListener('change', ()=> rebuildPlanOptions(nativeCareer.value));
  })();
</script>

<style>
.ios-input{
  width:100%;
  height:42px;
  border-radius:12px;
  border:1px solid rgba(15,23,42,.12);
  padding:0 12px;
  background:#F5F8FB;
  color:#0f172a;
  box-shadow: inset 0 1px 0 rgba(255,255,255,.6);
}
.ios-input:focus{
  outline:none;
  border-color:#F8C160;
  box-shadow:0 0 0 3px rgba(248,193,96,.14);
}
.ios-label{
  display:block;
  font-size:12px;
  font-weight:700;
  margin-bottom:4px;
  color:#0f172a;
}
.ios-input-wrap{ position:relative; }
.ios-pw-toggle{
  position:absolute; right:10px; top:50%; transform:translateY(-50%);
  font-weight:700; background:transparent; border:0; cursor:pointer;
}

.native-select{
  position:absolute !important;
  opacity:0 !important;
  pointer-events:none !important;
  width:0; height:0; padding:0; margin:0; border:0;
}

.cs-select{ position: relative; display:block; margin-top:4px; }
.cs-trigger{
  width:100%; height:42px;
  display:flex; align-items:center; justify-content:space-between;
  padding:0 12px;
  background:#F5F8FB;
  color:#0F172A;
  border:1px solid #0000001c;
  border-radius:12px;
  cursor:pointer;
}
.cs-chevron{ width:18px; height:18px; color:#000; }
.cs-value{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

.cs-menu{
  position:absolute; left:0; right:0; top: calc(100% + 4px);
  background:#F5F8FB;
  color:#0F172A;
  border:1px solid #0000001c;
  border-radius:12px;
  box-shadow: 0 10px 24px rgba(15,23,42,.10);
  padding:6px;
  list-style:none; margin:0;
  z-index: 1000;
  display:none;
}
.cs-select.is-open .cs-menu{ display:block; }

.cs-option{ padding:8px 10px; border-radius:10px; cursor:pointer; }
.cs-option:hover{ background:#E8EEF6; }
.cs-option.is-selected{ background:#FFE9C9; font-weight:700; }
</style>
